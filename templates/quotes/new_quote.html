{% extends 'base.html' %}
{% block title %}Nueva cotizacion{% endblock %}
{% block content %}
<style>
    body {
        background: #f5f6f7;
    }
    main {
        max-width: 1180px;
    }
    .card {
        border-radius: 30px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 22px 55px rgba(15, 23, 42, 0.08);
        background: #ffffff;
        padding: 34px;
    }
    .quote-shell {
        display: grid;
        gap: 22px;
    }
    .section-box {
        border: 1px solid #ebedf0;
        border-radius: 22px;
        padding: 22px;
        background: #fcfcfd;
    }
    .section-head {
        margin-bottom: 16px;
    }
    .section-title {
        margin: 0;
        font-size: 18px;
    }
    .section-subtitle {
        margin: 5px 0 0;
        color: #667085;
        font-size: 13px;
    }
    .logistics-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 16px;
    }
    .field label {
        font-size: 13px;
        color: #475467;
        margin-bottom: 8px;
        font-weight: 600;
    }
    input, select {
        border-radius: 12px;
        border: 1px solid #d0d5dd;
        background: #fff;
        padding: 12px 13px;
    }
    input:focus, select:focus {
        border-color: #344054;
        outline: 3px solid rgba(52, 64, 84, 0.12);
    }
    .transport-picker {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
    }
    .transport-option {
        border: 1px solid #d0d5dd;
        border-radius: 14px;
        background: #fff;
        padding: 14px;
        cursor: pointer;
        text-align: left;
        transition: border-color 0.2s ease, background-color 0.2s ease;
    }
    .transport-option:hover {
        border-color: #98a2b3;
    }
    .transport-option.is-selected {
        border-color: #111827;
        background: #f9fafb;
    }
    .transport-label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        color: #111827;
    }
    .transport-label svg {
        width: 19px;
        height: 19px;
        stroke: currentColor;
        fill: none;
        stroke-width: 1.6;
    }
    .transport-hint {
        margin: 6px 0 0;
        font-size: 12px;
        color: #667085;
    }
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        border: 0;
    }
    .pieces-head {
        display: grid;
        grid-template-columns: minmax(180px, 280px) 1fr;
        gap: 16px;
        align-items: end;
        margin-bottom: 16px;
    }
    .items-list {
        display: grid;
        gap: 12px;
    }
    .item-row {
        border: 1px solid #e4e7ec;
        border-radius: 14px;
        background: #fff;
        padding: 12px;
        display: grid;
        grid-template-columns: 42px repeat(4, minmax(120px, 1fr));
        gap: 10px;
        align-items: end;
    }
    .piece-index {
        width: 28px;
        height: 28px;
        border-radius: 999px;
        background: #111827;
        color: #fff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 6px;
    }
    .mini-label {
        display: block;
        font-size: 11px;
        line-height: 1.2;
        color: #667085;
        margin-bottom: 6px;
        font-weight: 600;
    }
    .actions {
        justify-content: flex-end;
        margin-top: 10px;
    }
    .btn {
        background: #111827;
        border-radius: 12px;
        padding: 12px 18px;
    }
    .btn:hover {
        background: #0b1220;
    }
    @media (max-width: 900px) {
        .card {
            padding: 22px;
            border-radius: 22px;
        }
        .logistics-grid,
        .transport-picker,
        .pieces-head {
            grid-template-columns: 1fr;
        }
        .item-row {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="quote-shell">
    <div class="page-title">
        <h1>Nueva cotizacion</h1>
        <p class="subtle">Flujo simplificado para equipo comercial.</p>
    </div>

    <form method="post" id="quote-form">
        {% csrf_token %}
        {{ form.non_field_errors }}

        <section class="section-box">
            <div class="section-head">
                <h2 class="section-title">Logistica</h2>
                <p class="section-subtitle">Define los paises de salida y llegada.</p>
            </div>
            <div class="logistics-grid">
                <div class="field">
                    <label for="{{ form.origin_country.id_for_label }}">Origen</label>
                    {{ form.origin_country }}
                    {{ form.origin_country.errors }}
                </div>
                <div class="field">
                    <label for="{{ form.destination_country.id_for_label }}">Destino</label>
                    {{ form.destination_country }}
                    {{ form.destination_country.errors }}
                </div>
            </div>
        </section>

        <section class="section-box">
            <div class="section-head">
                <h2 class="section-title">Transporte</h2>
                <p class="section-subtitle">Selecciona la modalidad para el calculo.</p>
            </div>
            <div class="transport-picker" id="transport-picker">
                <button type="button" class="transport-option" data-transport="AIR">
                    <div class="transport-label">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M2 13.5L10 12L21 5.5L19.5 4L10.5 8L7 5H5L6 9L2.5 11L2 13.5Z"></path>
                            <path d="M10.5 12.5L14.5 18H12.5L9.5 14.5L10.5 12.5Z"></path>
                        </svg>
                        <span>Aereo</span>
                    </div>
                    <p class="transport-hint">Ideal para tiempos de entrega cortos.</p>
                </button>
                <button type="button" class="transport-option" data-transport="SEA">
                    <div class="transport-label">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M3 14H21L18 9H6L3 14Z"></path>
                            <path d="M7 9V6H12V9"></path>
                            <path d="M3 17C4.4 18.3 5.8 18.3 7.2 17C8.6 15.7 10 15.7 11.4 17C12.8 18.3 14.2 18.3 15.6 17C17 15.7 18.4 15.7 19.8 17C20.5 17.6 21.2 17.9 22 18"></path>
                        </svg>
                        <span>Maritimo</span>
                    </div>
                    <p class="transport-hint">Enfocado en volumen y eficiencia de costo.</p>
                </button>
            </div>
            <div class="sr-only">
                {{ form.transport_type }}
            </div>
            {{ form.transport_type.errors }}
        </section>

        <section class="section-box">
            <div class="section-head">
                <h2 class="section-title">Carga</h2>
                <p class="section-subtitle">Ingresa cantidad y detalle dimensional por pieza.</p>
            </div>

            <div class="pieces-head">
                <div class="field">
                    <label for="{{ form.pieces_count.id_for_label }}">Cantidad de piezas</label>
                    {{ form.pieces_count }}
                    {{ form.pieces_count.errors }}
                    <span class="help">{{ form.pieces_count.help_text }}</span>
                </div>
            </div>

            {{ formset.non_form_errors }}
            {{ formset.management_form }}

            <div class="items-list" id="items-list">
                {% for item_form in formset %}
                <div class="item-row">
                    <div>
                        <span class="piece-index">{{ forloop.counter }}</span>
                    </div>
                    <div>
                        <label class="mini-label" for="{{ item_form.weight_kg.id_for_label }}">Peso (kg)</label>
                        {{ item_form.weight_kg.errors }}
                        {{ item_form.weight_kg }}
                    </div>
                    <div>
                        <label class="mini-label" for="{{ item_form.length_cm.id_for_label }}">Largo (cm)</label>
                        {{ item_form.length_cm.errors }}
                        {{ item_form.length_cm }}
                    </div>
                    <div>
                        <label class="mini-label" for="{{ item_form.width_cm.id_for_label }}">Ancho (cm)</label>
                        {{ item_form.width_cm.errors }}
                        {{ item_form.width_cm }}
                    </div>
                    <div>
                        <label class="mini-label" for="{{ item_form.height_cm.id_for_label }}">Alto (cm)</label>
                        {{ item_form.height_cm.errors }}
                        {{ item_form.height_cm }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>

        <div class="actions">
            <button class="btn" type="submit">Calcular y guardar</button>
        </div>
    </form>
</div>

<template id="empty-form-template">
    <div class="item-row">
        <div>
            <span class="piece-index"></span>
        </div>
        <div>
            <label class="mini-label" for="id_items-__prefix__-weight_kg">Peso (kg)</label>
            {{ formset.empty_form.weight_kg }}
        </div>
        <div>
            <label class="mini-label" for="id_items-__prefix__-length_cm">Largo (cm)</label>
            {{ formset.empty_form.length_cm }}
        </div>
        <div>
            <label class="mini-label" for="id_items-__prefix__-width_cm">Ancho (cm)</label>
            {{ formset.empty_form.width_cm }}
        </div>
        <div>
            <label class="mini-label" for="id_items-__prefix__-height_cm">Alto (cm)</label>
            {{ formset.empty_form.height_cm }}
        </div>
    </div>
</template>

<script>
(function () {
    const transportSelect = document.getElementById('id_transport_type');
    const transportPicker = document.getElementById('transport-picker');
    const transportButtons = transportPicker ? transportPicker.querySelectorAll('.transport-option') : [];
    const piecesInput = document.getElementById('id_pieces_count');
    const totalFormsInput = document.getElementById('id_items-TOTAL_FORMS');
    const itemsList = document.getElementById('items-list');
    const template = document.getElementById('empty-form-template').innerHTML;

    function syncTransportUI() {
        if (!transportSelect) return;
        transportButtons.forEach((btn) => {
            btn.classList.toggle('is-selected', btn.dataset.transport === transportSelect.value);
        });
    }

    if (transportSelect && transportButtons.length) {
        transportButtons.forEach((btn) => {
            btn.addEventListener('click', function () {
                transportSelect.value = btn.dataset.transport;
                syncTransportUI();
            });
        });
        syncTransportUI();
    }

    function refreshRowIndices() {
        const rows = itemsList.querySelectorAll('.item-row');
        rows.forEach((row, idx) => {
            const badge = row.querySelector('.piece-index');
            if (badge) {
                badge.textContent = (idx + 1).toString();
            }
        });
    }

    function clampCount(value) {
        if (Number.isNaN(value)) return 1;
        return Math.max(1, Math.min(200, value));
    }

    function syncRows(targetCount) {
        const currentRows = itemsList.querySelectorAll('.item-row').length;
        if (targetCount > currentRows) {
            for (let i = currentRows; i < targetCount; i += 1) {
                const rowHtml = template.replaceAll('__prefix__', i.toString());
                itemsList.insertAdjacentHTML('beforeend', rowHtml);
            }
        } else if (targetCount < currentRows) {
            for (let i = currentRows; i > targetCount; i -= 1) {
                const row = itemsList.querySelector('.item-row:last-child');
                if (row) row.remove();
            }
        }
        totalFormsInput.value = targetCount;
        refreshRowIndices();
    }

    function handlePiecesChange() {
        const desired = clampCount(parseInt(piecesInput.value, 10));
        if (piecesInput.value !== desired.toString()) {
            piecesInput.value = desired.toString();
        }
        syncRows(desired);
    }

    piecesInput.addEventListener('change', handlePiecesChange);
    piecesInput.addEventListener('input', handlePiecesChange);
    handlePiecesChange();
})();
</script>
{% endblock %}
