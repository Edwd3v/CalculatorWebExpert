{% extends 'base.html' %}
{% block title %}Nueva cotizacion{% endblock %}
{% block content %}
<div class="page-title">
    <h1>Nueva cotizacion</h1>
    <p class="subtle">Cotiza tus piezas en USD. El formulario de piezas se ajusta automaticamente.</p>
</div>

<style>
    .transport-picker {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
        margin-top: 6px;
    }
    .transport-option {
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #fff;
        padding: 14px;
        text-align: left;
        cursor: pointer;
        transition: transform 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
    }
    .transport-option:hover {
        border-color: var(--accent-2);
        transform: translateY(-1px);
    }
    .transport-option.is-selected {
        border-color: var(--accent);
        background: #eef6f2;
        box-shadow: inset 0 0 0 1px var(--accent);
        animation: transport-pulse 260ms ease-out;
    }
    .transport-option .icon {
        width: 30px;
        height: 30px;
        display: block;
        color: var(--accent);
        margin-bottom: 8px;
    }
    .transport-option strong {
        display: block;
        font-size: 15px;
    }
    .transport-option span {
        color: var(--ink-soft);
        font-size: 13px;
    }
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }
    @keyframes transport-pulse {
        0% {
            transform: scale(0.98);
            box-shadow: inset 0 0 0 0 var(--accent);
        }
        70% {
            transform: scale(1.01);
            box-shadow: inset 0 0 0 1px var(--accent), 0 6px 18px rgba(13, 59, 46, 0.16);
        }
        100% {
            transform: scale(1);
            box-shadow: inset 0 0 0 1px var(--accent);
        }
    }
    @media (max-width: 900px) {
        .transport-picker { grid-template-columns: 1fr; }
    }
</style>

<form method="post" id="quote-form">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <div class="form-grid">
        <div class="field">
            <label for="{{ form.transport_type.id_for_label }}">Tipo de transporte</label>
            <div class="transport-picker" id="transport-picker">
                <button type="button" class="transport-option" data-transport="AIR">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M2 13.5L10 12L21 5.5L19.5 4L10.5 8L7 5H5L6 9L2.5 11L2 13.5Z" fill="currentColor"/>
                        <path d="M10.5 12.5L14.5 18H12.5L9.5 14.5L10.5 12.5Z" fill="currentColor"/>
                    </svg>
                    <strong>Aereo</strong>
                    <span>Tarifa unica: se cobra por mayor entre KG y M3.</span>
                </button>
                <button type="button" class="transport-option" data-transport="SEA">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M3 14H21L18 9H6L3 14Z" fill="currentColor"/>
                        <path d="M7 9V6H12V9" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
                        <path d="M3 17C4.4 18.3 5.8 18.3 7.2 17C8.6 15.7 10 15.7 11.4 17C12.8 18.3 14.2 18.3 15.6 17C17 15.7 18.4 15.7 19.8 17C20.5 17.6 21.2 17.9 22 18" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
                    </svg>
                    <strong>Maritimo</strong>
                    <span>Tarifa unica: se cobra por mayor entre KG y M3.</span>
                </button>
            </div>
            <div class="sr-only">
                {{ form.transport_type }}
            </div>
            {{ form.transport_type.errors }}
        </div>
        <div class="field">
            <label for="{{ form.origin_location.id_for_label }}">Origen (Puerto/Aeropuerto)</label>
            <select name="{{ form.origin_location.name }}" id="{{ form.origin_location.id_for_label }}" required>
                <option value="">Selecciona origen</option>
                {% for origin in form.fields.origin_location.queryset %}
                    <option
                        value="{{ origin.id }}"
                        data-location-type="{{ origin.location_type }}"
                        {% if form.origin_location.value|stringformat:"s" == origin.id|stringformat:"s" %}selected{% endif %}
                    >
                        {{ origin.code }} - {{ origin.name }} ({{ origin.get_location_type_display }})
                    </option>
                {% endfor %}
            </select>
            {{ form.origin_location.errors }}
            <span class="help">Se mostraran aeropuertos para aereo y puertos para maritimo.</span>
        </div>
        <div class="field">
            <label for="{{ form.pieces_count.id_for_label }}">Cantidad de piezas</label>
            {{ form.pieces_count }}
            {{ form.pieces_count.errors }}
            <span class="help">{{ form.pieces_count.help_text }}</span>
        </div>
    </div>

    <div class="section">
        <h2>Piezas</h2>
        <p class="subtle">Completa los datos de cada pieza (peso y dimensiones).</p>
        {{ formset.non_form_errors }}
        {{ formset.management_form }}

        <table id="items-table">
            <thead>
                <tr>
                    <th>Peso (kg)</th>
                    <th>Largo (cm)</th>
                    <th>Ancho (cm)</th>
                    <th>Alto (cm)</th>
                </tr>
            </thead>
            <tbody>
                {% for item_form in formset %}
                <tr class="item-row">
                    <td>{{ item_form.weight_kg.errors }}{{ item_form.weight_kg }}</td>
                    <td>{{ item_form.length_cm.errors }}{{ item_form.length_cm }}</td>
                    <td>{{ item_form.width_cm.errors }}{{ item_form.width_cm }}</td>
                    <td>{{ item_form.height_cm.errors }}{{ item_form.height_cm }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="actions">
        <button class="btn" type="submit">Calcular y guardar</button>
    </div>
</form>

<template id="empty-form-template">
    <tr class="item-row">
        <td>{{ formset.empty_form.weight_kg }}</td>
        <td>{{ formset.empty_form.length_cm }}</td>
        <td>{{ formset.empty_form.width_cm }}</td>
        <td>{{ formset.empty_form.height_cm }}</td>
    </tr>
</template>

<script>
(function () {
    const transportSelect = document.getElementById('id_transport_type');
    const transportPicker = document.getElementById('transport-picker');
    const transportButtons = transportPicker ? transportPicker.querySelectorAll('.transport-option') : [];
    const originSelect = document.getElementById('id_origin_location');
    const piecesInput = document.getElementById('id_pieces_count');
    const totalFormsInput = document.getElementById('id_items-TOTAL_FORMS');
    const tbody = document.querySelector('#items-table tbody');
    const template = document.getElementById('empty-form-template').innerHTML;

    function syncTransportUI() {
        if (!transportSelect) return;
        transportButtons.forEach((btn) => {
            const isSelected = btn.dataset.transport === transportSelect.value;
            btn.classList.toggle('is-selected', isSelected);
        });
        syncOriginOptions();
    }

    function syncOriginOptions() {
        if (!originSelect || !transportSelect) return;
        const selectedTransport = transportSelect.value;
        const expectedType = selectedTransport === 'AIR' ? 'AIRPORT' : 'SEAPORT';
        let hasCurrentSelection = false;
        Array.from(originSelect.options).forEach((opt) => {
            if (!opt.value) {
                opt.hidden = false;
                return;
            }
            const visible = opt.dataset.locationType === expectedType;
            opt.hidden = !visible;
            if (visible && opt.selected) {
                hasCurrentSelection = true;
            }
        });
        if (!hasCurrentSelection) {
            originSelect.value = '';
        }
    }

    if (transportSelect && transportButtons.length) {
        transportButtons.forEach((btn) => {
            btn.addEventListener('click', function () {
                transportSelect.value = btn.dataset.transport;
                syncTransportUI();
            });
        });
        syncTransportUI();
    }

    function clampCount(value) {
        if (Number.isNaN(value)) {
            return 1;
        }
        return Math.max(1, Math.min(200, value));
    }

    function syncRows(targetCount) {
        const currentRows = tbody.querySelectorAll('.item-row').length;
        if (targetCount > currentRows) {
            for (let i = currentRows; i < targetCount; i += 1) {
                const rowHtml = template.replaceAll('__prefix__', i.toString());
                tbody.insertAdjacentHTML('beforeend', rowHtml);
            }
        } else if (targetCount < currentRows) {
            for (let i = currentRows; i > targetCount; i -= 1) {
                const row = tbody.querySelector('.item-row:last-child');
                if (row) {
                    row.remove();
                }
            }
        }
        totalFormsInput.value = targetCount;
    }

    function handlePiecesChange() {
        const desired = clampCount(parseInt(piecesInput.value, 10));
        if (piecesInput.value !== desired.toString()) {
            piecesInput.value = desired.toString();
        }
        syncRows(desired);
    }

    piecesInput.addEventListener('change', handlePiecesChange);
    piecesInput.addEventListener('input', handlePiecesChange);
    handlePiecesChange();
})();
</script>
{% endblock %}
